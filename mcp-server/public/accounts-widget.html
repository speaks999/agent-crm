<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Accounts</title>
    <style>
      :root {
        color: #0b0b0f;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
      }

      html,
      body {
        width: 100%;
        min-height: 100%;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        padding: 16px;
        background: #f6f8fb;
      }

      main {
        width: 100%;
        max-width: 600px;
        min-height: 300px;
        margin: 0 auto;
        background: #fff;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
      }

      h2 {
        margin: 0 0 16px;
        font-size: 1.25rem;
        font-weight: 600;
      }

      .add-form {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        padding: 12px;
        background: #f2f4fb;
        border-radius: 12px;
        flex-wrap: wrap;
      }

      .add-form input {
        flex: 1;
        min-width: 150px;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #cad3e0;
        font-size: 0.9rem;
      }

      .add-form button {
        border: none;
        border-radius: 8px;
        background: #111bf5;
        color: white;
        font-weight: 600;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 0.9rem;
      }

      .accounts-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .account-item {
        background: #f2f4fb;
        border-radius: 12px;
        padding: 12px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .account-info {
        flex: 1;
        min-width: 0;
      }

      .account-name {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .account-details {
        font-size: 0.85rem;
        color: #6c768a;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .account-actions {
        display: flex;
        gap: 8px;
      }

      .account-actions button {
        border: none;
        background: transparent;
        color: #6c768a;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.85rem;
      }

      .account-actions button:hover {
        background: #e2e8f0;
        color: #0b0b0f;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c768a;
      }
    </style>
  </head>
  <body>
    <main>
      <h2>Accounts</h2>
      <form class="add-form" id="add-form" autocomplete="off">
        <input id="name-input" name="name" placeholder="Company name" required />
        <input id="industry-input" name="industry" placeholder="Industry" />
        <input id="website-input" name="website" type="url" placeholder="Website" />
        <button type="submit">Add</button>
      </form>
      <ul class="accounts-list" id="accounts-list"></ul>
    </main>

    <script type="module">
      const listEl = document.querySelector("#accounts-list");
      const formEl = document.querySelector("#add-form");
      const nameInput = document.querySelector("#name-input");
      const industryInput = document.querySelector("#industry-input");
      const websiteInput = document.querySelector("#website-input");

      let accounts = [...(window.openai?.toolOutput?.accounts ?? [])];

      const render = () => {
        listEl.innerHTML = "";

        if (accounts.length === 0) {
          listEl.innerHTML = '<li class="empty-state">No accounts found</li>';
          return;
        }

        accounts.forEach((account) => {
          const li = document.createElement("li");
          li.className = "account-item";
          li.dataset.id = account.id;

          const info = document.createElement("div");
          info.className = "account-info";

          const name = document.createElement("div");
          name.className = "account-name";
          name.textContent = account.name;

          const details = document.createElement("div");
          details.className = "account-details";

          if (account.industry) {
            const industry = document.createElement("span");
            industry.textContent = account.industry;
            details.appendChild(industry);
          }

          if (account.website) {
            const website = document.createElement("span");
            website.textContent = account.website;
            details.appendChild(website);
          }

          info.appendChild(name);
          info.appendChild(details);

          const actions = document.createElement("div");
          actions.className = "account-actions";

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Delete";
          deleteBtn.onclick = () => callAccountTool("delete_account", { id: account.id });
          actions.appendChild(deleteBtn);

          li.appendChild(info);
          li.appendChild(actions);
          listEl.appendChild(li);
        });
      };

      const updateFromResponse = (response) => {
        if (response?.structuredContent?.accounts) {
          accounts = response.structuredContent.accounts;
          render();
        }
      };

      const handleSetGlobals = (event) => {
        const globals = event.detail?.globals;
        if (!globals?.toolOutput?.accounts) return;
        accounts = globals.toolOutput.accounts;
        render();
      };

      window.addEventListener("openai:set_globals", handleSetGlobals, {
        passive: true,
      });

      const mutateAccountsLocally = (name, payload) => {
        if (name === "add_account" || name === "create_account") {
          accounts = [
            ...accounts,
            {
              id: crypto.randomUUID(),
              name: payload.name,
              industry: payload.industry || null,
              website: payload.website || null,
            },
          ];
        }

        if (name === "delete_account") {
          accounts = accounts.filter((a) => a.id !== payload.id);
        }

        if (name === "update_account") {
          accounts = accounts.map((a) =>
            a.id === payload.id ? { ...a, ...payload } : a
          );
        }

        render();
      };

      const callAccountTool = async (name, payload) => {
        if (!window.openai?.tool) {
          console.error("OpenAI tool API not available");
          mutateAccountsLocally(name, payload);
          return;
        }

        try {
          const response = await window.openai.tool(name, payload);
          updateFromResponse(response);
        } catch (error) {
          console.error("Tool call failed:", error);
          mutateAccountsLocally(name, payload);
        }
      };

      formEl.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(formEl);
        const payload = {
          name: formData.get("name"),
          industry: formData.get("industry") || null,
          website: formData.get("website") || null,
        };

        await callAccountTool("create_account", payload);

        nameInput.value = "";
        industryInput.value = "";
        websiteInput.value = "";
      });

      // Initial render
      render();
    </script>
  </body>
</html>

