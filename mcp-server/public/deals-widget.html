<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Deals</title>
    <style>
      :root {
        color: #0b0b0f;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
      }

      html,
      body {
        width: 100%;
        min-height: 100%;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        padding: 16px;
        background: #f6f8fb;
      }

      main {
        width: 100%;
        max-width: 800px;
        min-height: 400px;
        margin: 0 auto;
        background: #fff;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
      }

      h2 {
        margin: 0 0 16px;
        font-size: 1.25rem;
        font-weight: 600;
      }

      .add-form {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        padding: 12px;
        background: #f2f4fb;
        border-radius: 12px;
        flex-wrap: wrap;
      }

      .add-form input {
        flex: 1;
        min-width: 120px;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #cad3e0;
        font-size: 0.9rem;
      }

      .add-form input[type="number"] {
        width: 100px;
      }

      .add-form button {
        border: none;
        border-radius: 8px;
        background: #111bf5;
        color: white;
        font-weight: 600;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 0.9rem;
      }

      .deals-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .stage-column {
        background: #f2f4fb;
        border-radius: 12px;
        padding: 12px;
        min-height: 200px;
      }

      .stage-header {
        font-weight: 600;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid #cad3e0;
      }

      .deals-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .deal-item {
        background: #fff;
        border-radius: 8px;
        padding: 10px;
        border-left: 3px solid #111bf5;
        cursor: pointer;
      }

      .deal-item:hover {
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
      }

      .deal-name {
        font-weight: 600;
        margin-bottom: 4px;
        font-size: 0.95rem;
      }

      .deal-amount {
        color: #111bf5;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .deal-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        margin-top: 4px;
      }

      .deal-status.open {
        background: #e0f2fe;
        color: #0369a1;
      }

      .deal-status.won {
        background: #d1fae5;
        color: #065f46;
      }

      .deal-status.lost {
        background: #fee2e2;
        color: #991b1b;
      }

      .empty-state {
        text-align: center;
        padding: 20px;
        color: #6c768a;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <main>
      <h2>Deals Pipeline</h2>
      <form class="add-form" id="add-form" autocomplete="off">
        <input id="name-input" name="name" placeholder="Deal name" required />
        <input id="amount-input" name="amount" type="number" placeholder="Amount" />
        <input id="stage-input" name="stage" placeholder="Stage" required />
        <button type="submit">Add Deal</button>
      </form>
      <div class="deals-container" id="deals-container"></div>
    </main>

    <script type="module">
      const containerEl = document.querySelector("#deals-container");
      const formEl = document.querySelector("#add-form");
      const nameInput = document.querySelector("#name-input");
      const amountInput = document.querySelector("#amount-input");
      const stageInput = document.querySelector("#stage-input");

      let deals = [...(window.openai?.toolOutput?.deals ?? [])];

      const render = () => {
        containerEl.innerHTML = "";

        if (deals.length === 0) {
          containerEl.innerHTML = '<div class="empty-state">No deals found</div>';
          return;
        }

        // Group deals by stage
        const dealsByStage = {};
        deals.forEach((deal) => {
          if (!dealsByStage[deal.stage]) {
            dealsByStage[deal.stage] = [];
          }
          dealsByStage[deal.stage].push(deal);
        });

        // Create columns for each stage
        Object.entries(dealsByStage).forEach(([stage, stageDeals]) => {
          const column = document.createElement("div");
          column.className = "stage-column";

          const header = document.createElement("div");
          header.className = "stage-header";
          header.textContent = `${stage} (${stageDeals.length})`;
          column.appendChild(header);

          const list = document.createElement("ul");
          list.className = "deals-list";

          stageDeals.forEach((deal) => {
            const li = document.createElement("li");
            li.className = "deal-item";
            li.dataset.id = deal.id;

            const name = document.createElement("div");
            name.className = "deal-name";
            name.textContent = deal.name;

            const amount = document.createElement("div");
            amount.className = "deal-amount";
            amount.textContent = deal.amount
              ? `$${deal.amount.toLocaleString()}`
              : "No amount";

            const status = document.createElement("div");
            status.className = `deal-status ${deal.status}`;
            status.textContent = deal.status.toUpperCase();

            li.appendChild(name);
            li.appendChild(amount);
            li.appendChild(status);
            list.appendChild(li);
          });

          column.appendChild(list);
          containerEl.appendChild(column);
        });
      };

      const updateFromResponse = (response) => {
        if (response?.structuredContent?.deals) {
          deals = response.structuredContent.deals;
          render();
        }
      };

      const handleSetGlobals = (event) => {
        const globals = event.detail?.globals;
        if (!globals?.toolOutput?.deals) return;
        deals = globals.toolOutput.deals;
        render();
      };

      window.addEventListener("openai:set_globals", handleSetGlobals, {
        passive: true,
      });

      const mutateDealsLocally = (name, payload) => {
        if (name === "add_deal" || name === "create_deal") {
          deals = [
            ...deals,
            {
              id: crypto.randomUUID(),
              name: payload.name,
              amount: payload.amount || null,
              stage: payload.stage,
              status: payload.status || "open",
            },
          ];
        }

        if (name === "delete_deal") {
          deals = deals.filter((d) => d.id !== payload.id);
        }

        if (name === "update_deal" || name === "move_deal_stage") {
          deals = deals.map((d) =>
            d.id === payload.id ? { ...d, ...payload } : d
          );
        }

        render();
      };

      const callDealTool = async (name, payload) => {
        if (!window.openai?.tool) {
          console.error("OpenAI tool API not available");
          mutateDealsLocally(name, payload);
          return;
        }

        try {
          const response = await window.openai.tool(name, payload);
          updateFromResponse(response);
        } catch (error) {
          console.error("Tool call failed:", error);
          mutateDealsLocally(name, payload);
        }
      };

      formEl.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(formEl);
        const payload = {
          name: formData.get("name"),
          stage: formData.get("stage"),
          amount: formData.get("amount")
            ? parseFloat(formData.get("amount"))
            : null,
        };

        await callDealTool("create_deal", payload);

        nameInput.value = "";
        amountInput.value = "";
        stageInput.value = "";
      });

      // Initial render
      render();
    </script>
  </body>
</html>

